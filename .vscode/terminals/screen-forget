#!/usr/bin/env bash
# vscode-screen-forget - Remove a single screen session, its log, and restore entry
#
# Usage: vscode-screen-forget [window-id]
#   e.g., vscode-screen-forget 10977-1767190321484
#
# If no argument, detects from $STY (screen session env var)

set -euo pipefail

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PROJECT="$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')"
RESTORE_FILE="$PROJECT_DIR/.vscode/restore-terminals.json"
LOGS_DIR="$PROJECT_DIR/.vscode/terminals/logs"

# Get window name
if [[ -n "${1:-}" ]]; then
  WINDOW="$1"
elif [[ -n "${STY:-}" ]]; then
  # Extract window name from session name (pax-1 -> 1)
  WINDOW="${STY#*.${PROJECT}-}"
  if [[ "$WINDOW" == "$STY" ]]; then
    echo "Error: Could not extract window name from session." >&2
    exit 1
  fi
else
  echo "Usage: vscode-screen-forget [window-name]"
  echo "   or run from inside a screen session"
  exit 1
fi

SESSION="${PROJECT}-${WINDOW}"

# Remove from restore-terminals.json
# Match the window ID in the commands array (e.g., "exec .vscode/terminals/screen-auto 2775-WA10ICb")
if [[ -f "$RESTORE_FILE" ]]; then
  tmp=$(mktemp)
  jq --arg window "$WINDOW" '
    .terminals = [.terminals[] | select(.splitTerminals[0].commands[0] | contains($window) | not)]
  ' "$RESTORE_FILE" > "$tmp" && mv "$tmp" "$RESTORE_FILE"
fi

# Delete the log file
rm -f "$LOGS_DIR/${SESSION}.log"

# Kill the screen session
# Use configured screen binary
SCREEN="${IMMORTERM_SCREEN_BINARY:-immorterm}"
$SCREEN -S "$SESSION" -X quit 2>/dev/null || true

# Also delete socket file directly (screen -X quit fails for "Remote or dead" sessions)
SCREEN_DIR="${SCREENDIR:-$HOME/.screen}"
for socket in "$SCREEN_DIR"/*."$SESSION"; do
  [[ -S "$socket" ]] && rm -f "$socket"
done
