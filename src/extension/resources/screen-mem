#!/usr/bin/env bash
# Get memory usage for current screen session
# Output format: "123M" (megabytes RSS)
#
# Challenge: $STY is not available in backtick context (runs in subshell)
# Solution: Use $PPID - screen runs backticks as direct children

SESSION_PID=""

# Method 1: Try $STY (works in some contexts)
if [[ -n "$STY" ]]; then
  SESSION_PID="${STY%%.*}"
fi

# Method 2: Parent process - screen runs backticks as direct children
if [[ -z "$SESSION_PID" || ! "$SESSION_PID" =~ ^[0-9]+$ ]]; then
  PARENT_COMM=$(ps -o comm= -p "$PPID" 2>/dev/null)
  SCREEN_BIN_NAME=$(basename "${IMMORTERM_SCREEN_BINARY:-screen-immorterm}")
  if [[ "$PARENT_COMM" == "$SCREEN_BIN_NAME" ]]; then
    SESSION_PID="$PPID"
  fi
fi

# Calculate memory if we have a valid PID
if [[ -n "$SESSION_PID" ]] && [[ "$SESSION_PID" =~ ^[0-9]+$ ]]; then
  # Get all child processes of the screen session
  PIDS=$(pgrep -P "$SESSION_PID" 2>/dev/null | tr '\n' ',' | sed 's/,$//')
  if [[ -n "$PIDS" ]]; then
    # Sum RSS memory of all children (in KB), convert to MB
    MEM_KB=$(ps -o rss= -p "$SESSION_PID,$PIDS" 2>/dev/null | awk '{sum+=$1} END {print sum+0}')
    MEM_MB=$((MEM_KB / 1024))
    echo "${MEM_MB}M"
  else
    echo "0M"
  fi
else
  echo "?M"
fi
