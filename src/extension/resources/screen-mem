#!/usr/bin/env bash
# Get memory usage for current screen session
# Output format: "123M" (megabytes RSS)

SESSION_PID=""

# Method 1: Try $STY - format is typically "PID.sessionname" or just the session name
if [[ -n "$STY" ]]; then
  # Extract numeric prefix if present
  if [[ "$STY" =~ ^([0-9]+)\. ]]; then
    SESSION_PID="${BASH_REMATCH[1]}"
  fi
fi

# Method 2: Walk up process tree to find screen/immorterm
if [[ -z "$SESSION_PID" || ! "$SESSION_PID" =~ ^[0-9]+$ ]]; then
  # Check parent and grandparent processes
  for pid in "$PPID" "$(ps -o ppid= -p "$PPID" 2>/dev/null | tr -d ' ')"; do
    if [[ -n "$pid" && "$pid" =~ ^[0-9]+$ ]]; then
      PROC_NAME=$(ps -o comm= -p "$pid" 2>/dev/null | tr '[:upper:]' '[:lower:]')
      if [[ "$PROC_NAME" == *screen* ]] || [[ "$PROC_NAME" == *immorterm* ]]; then
        SESSION_PID="$pid"
        break
      fi
    fi
  done
fi

# Method 3: Find by session name pattern in process list
if [[ -z "$SESSION_PID" || ! "$SESSION_PID" =~ ^[0-9]+$ ]]; then
  # Get project dir from environment (set by screenrc)
  if [[ -n "$SCREEN_PROJECT_DIR" ]]; then
    PROJECT_NAME=$(basename "$SCREEN_PROJECT_DIR")
    # Find immorterm/screen process with matching session name
    SESSION_PID=$(ps aux 2>/dev/null | grep -i "[i]mmorterm\|[s]creen" | grep -i "$PROJECT_NAME" | awk 'NR==1 {print $2}')
  fi
fi

# Calculate memory if we have a valid PID
if [[ -n "$SESSION_PID" ]] && [[ "$SESSION_PID" =~ ^[0-9]+$ ]]; then
  # Get all child PIDs including screen process itself
  CHILD_PIDS=$(pgrep -P "$SESSION_PID" 2>/dev/null | tr '\n' ',')
  ALL_PIDS="${SESSION_PID}"
  [[ -n "$CHILD_PIDS" ]] && ALL_PIDS="${SESSION_PID},${CHILD_PIDS%,}"

  MEM_KB=$(ps -o rss= -p "$ALL_PIDS" 2>/dev/null | awk '{sum+=$1} END {print sum+0}')
  MEM_MB=$((MEM_KB / 1024))
  echo "${MEM_MB}M"
else
  echo "?M"
fi
