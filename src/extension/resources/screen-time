#!/usr/bin/env bash
# Get last activity timestamp for screen status bar
# Tracks log file modification time - captures ALL terminal activity
# (shell commands, Claude conversations, any output)
# Output format: "19/01 14:30"

# Determine project directory from script location
# Script is at: {project}/.vscode/terminals/screen-time
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/../../.." && pwd)"
PROJECT_NAME=$(basename "$PROJECT_DIR")
LOGS_DIR="$SCRIPT_DIR/logs"

# Try to find log file for this session using $STY
LOG_FILE=""
if [[ -n "$STY" ]]; then
  # Extract window ID from STY (e.g., "3889.immorterm-test2-3889-yDhnAHfv")
  SESSION_NAME="${STY#*.}"  # Remove PID prefix -> "immorterm-test2-3889-yDhnAHfv"
  # Remove project name prefix to get window ID
  WINDOW_ID="${SESSION_NAME#"$PROJECT_NAME"-}"  # -> "3889-yDhnAHfv"

  if [[ -n "$WINDOW_ID" ]]; then
    LOG_FILE="$LOGS_DIR/${PROJECT_NAME}-${WINDOW_ID}.log"
  fi
fi

# Get log file modification time if it exists
if [[ -n "$LOG_FILE" && -f "$LOG_FILE" ]]; then
  if [[ "$(uname)" == "Darwin" ]]; then
    MTIME=$(stat -f "%Sm" -t "%d/%m %H:%M" "$LOG_FILE" 2>/dev/null)
  else
    MTIME=$(stat -c "%y" "$LOG_FILE" 2>/dev/null | cut -d'.' -f1 | awk '{
      split($1, d, "-"); split($2, t, ":");
      printf "%s/%s %s:%s", d[3], d[2], t[1], t[2]
    }')
  fi

  if [[ -n "$MTIME" ]]; then
    echo "$MTIME"
    exit 0
  fi
fi

# Fallback: find newest log file for this project
if [[ -d "$LOGS_DIR" ]]; then
  NEWEST_LOG=$(ls -t "$LOGS_DIR"/${PROJECT_NAME}-*.log 2>/dev/null | head -1)
  if [[ -n "$NEWEST_LOG" && -f "$NEWEST_LOG" ]]; then
    if [[ "$(uname)" == "Darwin" ]]; then
      MTIME=$(stat -f "%Sm" -t "%d/%m %H:%M" "$NEWEST_LOG" 2>/dev/null)
    else
      MTIME=$(stat -c "%y" "$NEWEST_LOG" 2>/dev/null | cut -d'.' -f1 | awk '{
        split($1, d, "-"); split($2, t, ":");
        printf "%s/%s %s:%s", d[3], d[2], t[1], t[2]
      }')
    fi

    if [[ -n "$MTIME" ]]; then
      echo "$MTIME"
      exit 0
    fi
  fi
fi

# Final fallback: current time
date '+%d/%m %H:%M'
