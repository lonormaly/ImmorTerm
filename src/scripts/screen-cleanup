#!/usr/bin/env bash
# ImmorTerm - screen-cleanup
# Remove stale entries from restore-terminals.json
# Cleans up entries for screen sessions that no longer exist

set -euo pipefail

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PROJECT="$(basename "$PROJECT_DIR" | tr '[:upper:]' '[:lower:]')"
JSON="$PROJECT_DIR/.vscode/restore-terminals.json"
LOGS_DIR="$PROJECT_DIR/.vscode/terminals/logs"

[[ -f "$JSON" ]] || exit 0

# Wait for screen to fully terminate after quit command
sleep 0.3

# Get list of active screen sessions for this project (extract the window ID part after PROJECT-)
active_ids=$(screen -ls 2>/dev/null | grep -oE "${PROJECT}-[0-9]+-[A-Za-z0-9]+" | sed "s/${PROJECT}-//" | sort -u || true)

# Get window IDs from JSON (extracted from commands array)
# Commands look like: "exec .vscode/terminals/screen-auto 12345-abcdef12"
window_ids_in_json=$(jq -r '.terminals[].splitTerminals[0].commands[0] // empty' "$JSON" 2>/dev/null | grep -oE '[0-9]+-[A-Za-z0-9]+' || true)

for window_id in $window_ids_in_json; do
  # If no matching session exists, remove the entry
  if ! echo "$active_ids" | grep -qxF "$window_id"; then
    echo "Removing stale entry for window ID: $window_id"
    tmp="$(mktemp)"
    # Remove entry where commands[0] contains this window ID
    jq --arg id "$window_id" '.terminals = [.terminals[] | select(.splitTerminals[0].commands[0] | contains($id) | not)]' "$JSON" > "$tmp" && mv "$tmp" "$JSON"
    # Also remove stale log file
    rm -f "$LOGS_DIR/${PROJECT}-${window_id}.log" 2>/dev/null || true
  fi
done

echo "Cleanup complete"
